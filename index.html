<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Detection App - ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #2ecc71;
            border-radius: 15px;
            padding: 40px;
            background: linear-gradient(45deg, #f8fff8, #e8f5e8);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #27ae60;
            background: linear-gradient(45deg, #f0fff0, #d5f0d5);
            transform: translateY(-2px);
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(46, 204, 113, 0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.5;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        .upload-icon {
            font-size: 3em;
            color: #2ecc71;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .upload-text {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .upload-subtext {
            color: #7f8c8d;
            font-size: 1em;
            position: relative;
            z-index: 1;
        }

        .file-input {
            display: none;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        #gliCanvas {
            width: 100%;
            height: auto;
            display: block;
        }

        .image-box canvas {
            max-width: 100%;
        }

        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-group input[type="range"] {
            flex: 1;
            min-width: 120px;
            height: 6px;
            background: #ddd;
            outline: none;
            border-radius: 3px;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #2ecc71;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .number-input {
            width: 80px;
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .number-input:focus {
            border-color: #2ecc71;
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .image-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .image-box h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.3em;
        }

        .image-box canvas {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .results {
            background: linear-gradient(135deg, #e8f8f5, #d5f4e6);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tree-count {
            font-size: 3em;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .results p {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .processing {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2ecc71;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2ecc71;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üå≥ Tree Detection App</h1>
            <p>‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>

        <div class="content">
            <div class="upload-section">
                <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</div>
                    <div class="upload-subtext">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB)</div>
                </div>
                <input type="file" id="imageInput" class="file-input" accept="image/*">
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="gliThreshold">GLI Threshold (‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö)</label>
                    <div class="input-group">
                        <input type="range" id="gliThreshold" min="0" max="0.3" step="0.01" value="0.1">
                        <input type="number" id="gliInput" min="0" max="0.3" step="0.01" value="0.1"
                            class="number-input">
                    </div>
                </div>
                <div class="control-group">
                    <label for="minArea">Min Area (‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ)</label>
                    <div class="input-group">
                        <input type="range" id="minArea" min="0.0" max="100" step="0.01" value="30">
                        <input type="number" id="areaInput" min="0.0" max="100" step="0.01" value="30"
                            class="number-input">
                    </div>
                </div>
                <div class="control-group">
                    <label for="clusterDistance">Cluster Distance (‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡πâ‡∏ô)</label>
                    <div class="input-group">
                        <input type="range" id="clusterDistance" min="0" max="100" step="0.5" value="30">
                        <input type="number" id="clusterInput" min="0" max="100" step="0.5" value="30"
                            class="number-input">
                    </div>
                </div>

                <div class="control-group">
                    <label for="areaSqm">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£):</label>
                    <div class="input-group">
                        <input type="number" id="areaSqm" value="1600" step="1" min="1" class="number-input">
                    </div>
                </div>

                <div class="control-group">
                    <button class="btn" id="processBtn" onclick="processImage()" disabled>üîÑ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
                </div>
            </div>

            <div class="processing" id="processing" style="display: none;">
                <div class="spinner"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏û...</p>
            </div>

            <div class="image-container" id="imageContainer" style="display: none;">
                <div class="image-box">
                    <h3>üñºÔ∏è ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</h3>
                    <canvas id="originalCanvas"></canvas>
                </div>
                <div class="image-box">
                    <h3>üåø ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà GLI (Green Leaf Index)</h3>
                    <canvas id="gliCanvas"></canvas>
                </div>
                <div class="image-box">
                    <h3>üî¥ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ</h3>
                    <canvas id="resultCanvas"></canvas>
                </div>
            </div>

            <div class="results" id="results" style="display: none;">
                <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</p>
                <input type="number" id="treeCountInput" class="tree-count" value="0" min="0" step="1"
                    style="width:120px; text-align:center;">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="imageSize">-</div>
                        <div class="stat-label">‡∏Ç‡∏ô‡∏≤‡∏î‡∏†‡∏≤‡∏û (‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="processTime">-</div>
                        <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="treeDensityRai">-</div>
                        <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô (‡∏ï‡πâ‡∏ô/‡πÑ‡∏£‡πà)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="areaRaiResult">-</div>
                        <div class="stat-label">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà (‡πÑ‡∏£‡πà)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            <input type="number" id="deadTreeCount" value="0" min="0" step="1"
                                style="width: 80px; text-align:center; font-size:1.5em; font-weight:bold; color: #e74c3c;">
                        </div>
                        <div class="stat-label">‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏±‡∏ö (‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏¢)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="healthPercentage">-</div>
                        <div class="stat-label">
                            ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï (%)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalImageData = null;
        let processedImageData = null;

        document.getElementById('gliThreshold').addEventListener('input', function () {
            document.getElementById('gliInput').value = this.value;
            refreshGLIFromUI();
        });
        document.getElementById('gliInput').addEventListener('input', function () {
            const value = Math.max(0, Math.min(0.3, parseFloat(this.value) || 0));
            this.value = value;
            document.getElementById('gliThreshold').value = value;
            refreshGLIFromUI();
        });

        document.getElementById('minArea').addEventListener('input', function () {
            document.getElementById('areaInput').value = this.value;
        });

        document.getElementById('areaInput').addEventListener('input', function () {
            const value = Math.max(0.01, parseFloat(this.value) || 0.01);
            this.value = value;
            document.getElementById('minArea').value = value;
        });

        document.getElementById('clusterDistance').addEventListener('input', function () {
            document.getElementById('clusterInput').value = this.value;
        });

        document.getElementById('clusterInput').addEventListener('input', function () {
            const value = Math.max(0, parseFloat(this.value) || 0);
            this.value = value;
            document.getElementById('clusterDistance').value = value;
        });

        document.getElementById('imageInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        loadImage(img);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function loadImage(img) {
            const canvas = document.getElementById('originalCanvas');
            const ctx = canvas.getContext('2d');

            const maxSize = 500;
            let { width, height } = img;
            const originalWidth = img.naturalWidth;
            const originalHeight = img.naturalHeight;
            const ratio = Math.min(maxSize / originalWidth, maxSize / originalHeight);
            width = originalWidth * ratio;
            height = originalHeight * ratio;

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            originalImageData = ctx.getImageData(0, 0, originalWidth, originalHeight);

            document.getElementById('processBtn').disabled = false;
            document.getElementById('imageSize').textContent = `${originalWidth} √ó ${originalHeight}`;

            refreshGLIFromUI();
        }

        function drawGLI(imageData, threshold = null) {
            const { data, width, height } = imageData;
            const out = new ImageData(width, height);
            const displayCanvas = document.getElementById('gliCanvas');
            const displayCtx = displayCanvas.getContext('2d');

            const maxSize = 500;
            const ratio = Math.min(maxSize / width, maxSize / height);
            const displayWidth = width * ratio;
            const displayHeight = height * ratio;
            displayCanvas.width = displayWidth;
            displayCanvas.height = displayHeight;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i + 1], b = data[i + 2];
                const gli = calculateGLI(r, g, b);

                let R = 0, G = 0, B = 0;
                if (gli >= 0) {
                    const t = Math.min(1, gli / 0.3);
                    G = 128 + Math.round(127 * t);
                    R = Math.round(128 * (1 - t));
                    B = Math.round(128 * (1 - t));
                } else {
                    const t = Math.min(1, (-gli) / 0.3);
                    R = 128 + Math.round(127 * t);
                    B = 128 + Math.round(127 * t);
                    G = Math.round(128 * (1 - t));
                }
                if (threshold !== null && gli > threshold) {
                    R = Math.min(255, R + 40);
                    G = Math.min(255, G + 40);
                    B = Math.min(255, B + 40);
                }
                out.data[i] = R;
                out.data[i + 1] = G;
                out.data[i + 2] = B;
                out.data[i + 3] = 255;
            }

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = maxSize;
            tempCanvas.height = maxSize;
            tempCtx.putImageData(out, 0, 0);

            displayCtx.drawImage(tempCanvas, 0, 0, displayWidth, displayHeight);
        }

        function refreshGLIFromUI() {
            if (!originalImageData) return;
            const th = parseFloat(document.getElementById('gliThreshold').value);
            drawGLI(originalImageData, th);
        }

        function calculateGLI(r, g, b) {
            const epsilon = 1e-6;
            return (2 * g - r - b) / (2 * g + r + b + epsilon);
        }

        function createBinaryMask(imageData, threshold) {
            const { data, width, height } = imageData;
            const mask = new Uint8Array(width * height);
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i + 1], b = data[i + 2];
                const gli = calculateGLI(r, g, b);
                const pixelIndex = i / 4;
                mask[pixelIndex] = gli > threshold ? 255 : 0;
            }
            return mask;
        }

        function morphologyOpen(mask, width, height) {
            const result = new Uint8Array(mask.length);
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = y * width + x;
                    let minVal = 255;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            minVal = Math.min(minVal, mask[(y + dy) * width + (x + dx)]);
                        }
                    }
                    result[idx] = minVal;
                }
            }
            const dilated = new Uint8Array(mask.length);
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = y * width + x;
                    let maxVal = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            maxVal = Math.max(maxVal, result[(y + dy) * width + (x + dx)]);
                        }
                    }
                    dilated[idx] = maxVal;
                }
            }
            return dilated;
        }

        function findContours(mask, width, height, minArea) {
            const visited = new Set();
            const contours = [];
            function floodFill(startX, startY) {
                const stack = [[startX, startY]];
                const points = [];
                while (stack.length > 0) {
                    const [x, y] = stack.pop();
                    const idx = y * width + x;
                    if (x < 0 || x >= width || y < 0 || y >= height || visited.has(idx) || mask[idx] === 0) {
                        continue;
                    }
                    visited.add(idx);
                    points.push([x, y]);
                    stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
                }
                return points;
            }
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    if (mask[idx] === 255 && !visited.has(idx)) {
                        const contour = floodFill(x, y);
                        if (contour.length >= minArea) {
                            contours.push(contour);
                        }
                    }
                }
            }
            return contours;
        }

        function getContourCenter(contour) {
            let sumX = 0, sumY = 0;
            for (const [x, y] of contour) {
                sumX += x;
                sumY += y;
            }
            return [Math.round(sumX / contour.length), Math.round(sumY / contour.length)];
        }

        function clusterCenters(centers, maxDistance) {
            const clusters = [];
            const used = new Set();
            for (let i = 0; i < centers.length; i++) {
                if (used.has(i)) continue;
                const cluster = [centers[i]];
                used.add(i);
                for (let j = i + 1; j < centers.length; j++) {
                    if (used.has(j)) continue;
                    const dist = Math.sqrt(Math.pow(centers[i][0] - centers[j][0], 2) + Math.pow(centers[i][1] - centers[j][1], 2));
                    if (dist <= maxDistance) {
                        cluster.push(centers[j]);
                        used.add(j);
                    }
                }
                let sumX = 0, sumY = 0;
                for (const [x, y] of cluster) {
                    sumX += x;
                    sumY += y;
                }
                clusters.push([Math.round(sumX / cluster.length), Math.round(sumY / cluster.length)]);
            }
            return clusters;
        }

        function calculateAndDisplayHealth() {
                const detectedTrees = parseInt(document.getElementById('treeCountInput').value) || 0;
                const deadTrees = parseInt(document.getElementById('deadTreeCount').value) || 0;
                const totalTrees = detectedTrees + deadTrees; // ‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const areaRai = parseFloat(document.getElementById('areaRaiResult').textContent) || 1;

                let percentage = 0;
                if (totalTrees > 0) {
                    percentage = (detectedTrees / totalTrees) * 100;
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const densityPerRai = (totalTrees / areaRai).toFixed(2);

                document.getElementById('healthPercentage').textContent = `${percentage.toFixed(2)} %`;
                document.getElementById('treeDensityRai').textContent = `${densityPerRai} ‡∏ï‡πâ‡∏ô/‡πÑ‡∏£‡πà`; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô
            }
        document.getElementById('treeCountInput').addEventListener('input', calculateAndDisplayHealth);
        document.getElementById('deadTreeCount').addEventListener('input', calculateAndDisplayHealth);

        function processImage() {
            if (!originalImageData) return;

            const startTime = performance.now();
            document.getElementById('processing').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('imageContainer').style.display = 'none';

            setTimeout(() => {
                try {
                    const gliThreshold = parseFloat(document.getElementById('gliThreshold').value);
                    const minArea = parseInt(document.getElementById('minArea').value);
                    const clusterDistance = parseInt(document.getElementById('clusterDistance').value);
                    const areaSqm = parseFloat(document.getElementById('areaSqm').value);

                    if (isNaN(areaSqm) || areaSqm <= 0) {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£) ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                        document.getElementById('processing').style.display = 'none';
                        return;
                    }

                    const areaRai = areaSqm / 1600;

                    const mask = createBinaryMask(originalImageData, gliThreshold);
                    const cleanMask = morphologyOpen(mask, originalImageData.width, originalImageData.height);
                    const contours = findContours(cleanMask, originalImageData.width, originalImageData.height, minArea);
                    const centers = contours.map(contour => getContourCenter(contour));
                    const filteredCenters = clusterCenters(centers, clusterDistance);

                    drawResults(filteredCenters);

                    const processingTime = ((performance.now() - startTime) / 1000).toFixed(2);

                    document.getElementById('processing').style.display = 'none';
                    document.getElementById('imageContainer').style.display = 'grid';
                    document.getElementById('results').style.display = 'block';
                    document.getElementById('treeCountInput').value = filteredCenters.length;
                    document.getElementById('processTime').textContent = `${processingTime}s`;

                    const treeCount = filteredCenters.length;
                    const densityPerRai = (treeCount / areaRai).toFixed(2);

                    document.getElementById('areaRaiResult').textContent = areaRai.toFixed(2);
                    document.getElementById('treeDensityRai').textContent = `${densityPerRai} ‡∏ï‡πâ‡∏ô/‡πÑ‡∏£‡πà`;

                    calculateAndDisplayHealth();

                } catch (error) {
                    console.error('Processing error:', error);
                    document.getElementById('processing').style.display = 'none';
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•');
                }
            }, 100);
        }

        function drawResults(centers) {
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            const maxSize = 500;

            const originalWidth = maxSize;
            const originalHeight = maxSize;
            const ratio = Math.min(maxSize / originalWidth, maxSize / originalHeight);
            const displayWidth = originalWidth * ratio;
            const displayHeight = originalHeight * ratio;

            canvas.width = displayWidth;
            canvas.height = displayHeight;

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = originalWidth;
            tempCanvas.height = originalHeight;
            tempCtx.putImageData(originalImageData, 0, 0);

            ctx.drawImage(tempCanvas, 0, 0, displayWidth, displayHeight);

            ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.lineWidth = 2;

            for (const [x, y] of centers) {
                const displayX = x * ratio;
                const displayY = y * ratio;
                ctx.beginPath();
                ctx.arc(displayX, displayY, 8, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üå≥', displayX, displayY + 4);
                ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
            }
        }
    </script>
</body>

</html>
